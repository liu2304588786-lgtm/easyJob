<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeJob æ‹›è˜èšåˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* åŠ å¯†ç§‘æŠ€é£æ ¼èƒŒæ™¯ */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* åŠ¨æ€ç½‘æ ¼èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 25s linear infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        /* å¤´éƒ¨æ ·å¼ */
        header { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(59, 130, 246, 0.2); }
        
        /* æœç´¢æ ç»ç’ƒæ‹Ÿæ€ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        /* å…¬å¸å¡ç‰‡æ ·å¼ */
        .company-card {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .company-card:hover {
            border-left-color: #3b82f6;
            transform: translateX(2px);
            background-color: rgba(255, 255, 255, 1) !important;
        }
        
        /* ä¸‹æ‹‰åˆ—è¡¨åŠ¨ç”» */
        .job-dropdown {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .job-dropdown.open {
            max-height: 2000px;
            opacity: 1;
        }
        
        .arrow-icon { transition: transform 0.3s ease; }
        .arrow-icon.rotate { transform: rotate(180deg); }

        .job-item.active {
            border-left-width: 4px;
            border-left-color: #3b82f6;
        }
        .job-item.selected {
            background-color: #eff6ff !important;
            border-color: #93c5fd !important;
        }

        /* æ¨¡æ€æ¡†é®ç½© */
        #config-modal { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }

    </style>
</head>
<body class="font-sans text-slate-900 pb-20">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg">
                    <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </div>
                <span class="font-bold text-xl tracking-tight">DeJob <span class="text-blue-400 font-light">Aggregator</span></span>
            </div>
            <div class="flex items-center gap-4 text-sm text-slate-400">
                <span class="hidden sm:inline">æ•°æ®æº: t.me/DeJob_official</span>
                <div class="flex items-center gap-1">
                    <div id="statusIndicator" class="h-2 w-2 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span id="statusText" class="text-xs">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4" style="min-height: calc(100vh - 56px);">
        <div id="main-view" class="flex flex-col lg:flex-row gap-6 h-full">
            <!-- å·¦ä¾§ï¼šèŒä½åˆ—è¡¨ -->
            <div class="flex-1 flex flex-col h-full overflow-hidden">
                <div class="glass-panel p-3 rounded-xl shadow-sm mb-3 sticky top-0 z-40">
                    <div class="flex flex-col md:flex-row gap-3 justify-between items-center">
                        <div class="relative w-full md:w-1/3">
                            <input type="text" id="searchInput" placeholder="æœç´¢å…¬å¸ã€å²—ä½..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                        </div>
                        <div class="flex gap-2 w-full md:w-auto overflow-x-auto">
                            <select id="categorySelect" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 cursor-pointer">
                                <option value="All">æ‰€æœ‰å²—ä½</option>
                                <option value="Dev">å¼€å‘ (Dev)</option>
                                <option value="Marketing">å¸‚åœº (Marketing)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-2 px-1 text-white/80">
                    <button onclick="toggleSelectAll()" id="selectAllBtn" class="text-sm font-medium text-blue-400 hover:text-blue-300">å…¨é€‰æœ¬é¡µ</button>
                    <span id="jobCount" class="text-xs">åŠ è½½ä¸­...</span>
                </div>
                <div id="jobList" class="flex-1 overflow-y-auto space-y-3 pb-10 pr-1">
                    <div class="text-center py-10 text-slate-400 animate-pulse">æ­£åœ¨ä»åç«¯è·å–æ•°æ®...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
            <div class="w-full lg:w-80 flex-shrink-0">
                <div class="glass-panel p-4 rounded-xl sticky top-4">
                    <h2 class="text-base font-bold text-slate-800 mb-3 flex items-center gap-2">æŠ•é€’åŠ©æ‰‹</h2>
                    <div class="mb-4">
                        <div class="relative group">
                            <input type="file" id="resumeInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-lg p-3 text-center transition-colors bg-slate-50 group-hover:border-blue-400">
                                <div id="uploadPlaceholder"><p class="text-sm text-slate-500">ç‚¹å‡»ä¸Šä¼ ç®€å† (PDF)</p></div>
                                <div id="fileInfo" class="hidden flex items-center justify-center gap-2 text-green-700">
                                    <span id="fileName" class="text-sm font-medium truncate max-w-[150px]"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-slate-600">å·²é€‰å²—ä½</span>
                            <span id="selectedCount" class="text-xl font-bold text-blue-600">0</span>
                        </div>
                        <button id="clearBtn" onclick="clearAllSelections()" class="w-full py-1.5 px-3 rounded text-xs font-bold text-slate-500 bg-slate-200 hover:bg-slate-300 transition-colors">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                    <button id="applyBtn" onclick="showConfigModal()" disabled class="w-full py-2.5 px-4 rounded-lg font-bold text-white shadow-lg transition-all bg-slate-300 cursor-not-allowed text-sm">ä¸€é”®æŠ•é€’</button>
                </div>
            </div>
        </div>

        <!-- é‚®ç®±é…ç½®æ¨¡æ€æ¡† (æ–°å¢) -->
        <div id="config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-[90%] transform transition-all scale-100">
                <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“® å‘ä»¶ç®±é…ç½®</h3>
                <p class="text-xs text-slate-500 mb-4 bg-blue-50 p-2 rounded">æ‚¨çš„éšç§å®‰å…¨ï¼šé…ç½®ä»…ç”¨äºæœ¬æ¬¡å‘é€ï¼Œä¸ä¼šä¿å­˜åœ¨æœåŠ¡å™¨ã€‚</p>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">é‚®ç®±æœåŠ¡å•†</label>
                        <select id="smtpProvider" onchange="updateSmtpConfig()" class="w-full border rounded p-2 text-sm">
                            <option value="qq">QQé‚®ç®± (æ¨è)</option>
                            <option value="gmail">Gmail</option>
                            <option value="163">163ç½‘æ˜“é‚®ç®±</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-700 mb-1">SMTP ä¸»æœº</label>
                            <input type="text" id="smtpHost" value="smtp.qq.com" class="w-full border rounded p-2 text-sm bg-slate-50" readonly>
                        </div>
                        <div class="w-20">
                            <label class="block text-xs font-medium text-slate-700 mb-1">ç«¯å£</label>
                            <input type="text" id="smtpPort" value="587" class="w-full border rounded p-2 text-sm bg-slate-50" readonly>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1">é‚®ç®±è´¦å·</label>
                        <input type="email" id="smtpUser" placeholder="ä¾‹å¦‚: 123456@qq.com" class="w-full border rounded p-2 text-sm">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-700 mb-1 flex justify-between">
                            <span>æˆæƒç  / åº”ç”¨å¯†ç </span>
                            <a href="https://docs.qq.com/doc/DYnFHQXVRc1ZLWHZW" target="_blank" class="text-blue-500 hover:underline">å¦‚ä½•è·å–?</a>
                        </label>
                        <input type="password" id="smtpPass" placeholder="ä¸æ˜¯ç™»å½•å¯†ç ï¼æ˜¯16ä½æˆæƒç " class="w-full border rounded p-2 text-sm">
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button onclick="closeConfigModal()" class="flex-1 py-2 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-100">å–æ¶ˆ</button>
                    <button onclick="startRealApplying()" class="flex-1 py-2 rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 shadow-md">ç¡®è®¤å‘é€</button>
                </div>
            </div>
        </div>

        <!-- å‘é€è¿›åº¦è§†å›¾ -->
        <div id="sending-view" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden mt-10">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800" id="progressTitle">æŠ•é€’ä»»åŠ¡é˜Ÿåˆ—</h2>
                <button onclick="resetView()" class="text-sm text-blue-600 hover:underline">è¿”å›åˆ—è¡¨</button>
            </div>
            <div class="h-1.5 w-full bg-slate-100">
                <div id="progressBar" class="h-full bg-green-500 transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
            <div id="logContainer" class="max-h-[500px] overflow-y-auto p-0"></div>
        </div>
    </main>

    <script>
        // ... (ä¿æŒä¹‹å‰çš„å˜é‡å®šä¹‰: FALLBACK_JOBS, currentJobs, groupedJobs, selectedIds, resumeFile, API_BASE_URL) ...
        const FALLBACK_JOBS = [ { id: "1", company: "Marisa", title: "Solidity Engineer", salary: "1800U", date: "2023-11-01", email: "hr@marisa.io", tags: ["Dev"], raw_content: "desc..." } ];
        let currentJobs = []; let groupedJobs = {}; let selectedIds = new Set(); let resumeFile = null;
        const API_BASE_URL = 'http://localhost:5000/api'; 

        document.addEventListener('DOMContentLoaded', () => { loadJobsData(); setupEventListeners(); });

        async function loadJobsData() {
            try {
                const response = await fetch(`${API_BASE_URL}/jobs`);
                const data = await response.json();
                if(Array.isArray(data) && data.length) {
                    currentJobs = data;
                    document.getElementById('statusIndicator').className = "h-2 w-2 rounded-full bg-green-500";
                    document.getElementById('statusText').innerText = "Live";
                } else { throw new Error("Empty"); }
            } catch (e) {
                currentJobs = [...FALLBACK_JOBS];
            }
            renderJobs();
        }

        // ... (ä¿æŒ renderJobs, toggleDropdown, selectJob, toggleSingle/GroupSelection, toggleSelectAll, clearAllSelections, updateActionState, setupEventListeners é€»è¾‘ä¸å˜) ...
        // æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†èŠ‚çœç¯‡å¹…çœç•¥äº†æœªä¿®æ”¹çš„å‡½æ•°ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·ä¿ç•™ä¹‹å‰çš„å®Œæ•´ JS ä»£ç ï¼Œåªæ›¿æ¢ä¸‹é¢çš„æŠ•é€’é€»è¾‘éƒ¨åˆ†

        function renderJobs() {
            const listEl = document.getElementById('jobList');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const catVal = document.getElementById('categorySelect').value;
            const filtered = currentJobs.filter(j => (j.company+j.title).toLowerCase().includes(searchVal));
            groupedJobs = filtered.reduce((acc, j) => {
                let c = (j.company||"å…¶ä»–").replace(/[#ï¼ƒ].*/, '').trim();
                if(!acc[c]) acc[c]=[]; acc[c].push(j); return acc;
            }, {});
            
            document.getElementById('jobCount').innerText = `${Object.keys(groupedJobs).length} ç»„ / ${filtered.length} ä¸ª`;
            listEl.innerHTML = '';
            
            Object.keys(groupedJobs).forEach(company => {
                const jobs = groupedJobs[company];
                const safeId = company.replace(/[^a-zA-Z0-9]/g, '_') + Math.floor(Math.random()*1000);
                const isGroupSel = jobs.every(j => selectedIds.has(String(j.id)));
                const selCount = jobs.filter(j => selectedIds.has(String(j.id))).length;
                
                const card = document.createElement('div');
                card.className = "company-card bg-white/95 backdrop-blur-sm rounded-xl border border-slate-200/50 overflow-hidden shadow-sm mb-3";
                card.innerHTML = `
                    <div class="p-4 cursor-pointer flex justify-between items-center bg-slate-50/80 hover:bg-slate-100" onclick="toggleDropdown('${safeId}')">
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 rounded-lg bg-blue-600 text-white flex items-center justify-center font-bold text-lg">${company[0].toUpperCase()}</div>
                            <div>
                                <h3 class="font-bold text-slate-800">${company}</h3>
                                <div class="text-xs text-slate-500">${jobs.length} å²—ä½ <span id="group-count-${safeId}" class="text-blue-600 font-bold ml-1 ${selCount>0?'':'hidden'}">å·²é€‰ ${selCount}</span></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-2" onclick="event.stopPropagation()">
                                <label class="text-xs text-slate-500 cursor-pointer">å…¨é€‰</label>
                                <input type="checkbox" id="group-chk-${safeId}" ${isGroupSel?'checked':''} onchange="toggleGroupSelection('${company}',this.checked,'${safeId}')" class="h-4 w-4">
                            </div>
                        </div>
                    </div>
                    <div id="dropdown-${safeId}" class="job-dropdown bg-white border-t border-slate-100">
                        <div class="flex flex-col md:flex-row gap-4 p-4 min-h-[200px]">
                            <div class="md:w-[35%] bg-slate-50 p-4 rounded text-xs text-slate-600">
                                <h4 id="dt-${safeId}" class="font-bold mb-2 border-b pb-1">${jobs[0].title}</h4>
                                <p id="dc-${safeId}">${(jobs[0].raw_content||"").replace(/[#ï¼ƒ]/g,'')}</p>
                            </div>
                            <div class="md:w-[65%] space-y-2">
                                ${jobs.map((j,i) => `
                                    <div id="job-row-${j.id}" class="job-item ${i===0?'active':''} ${selectedIds.has(String(j.id))?'selected':''} flex gap-3 p-3 border rounded cursor-pointer hover:bg-blue-50" onclick="selectJob(event,'${safeId}','${j.id}')">
                                        <input type="checkbox" id="job-chk-${j.id}" ${selectedIds.has(String(j.id))?'checked':''} onchange="toggleSingleSelection('${j.id}',this.checked,'${safeId}')" onclick="event.stopPropagation()">
                                        <div>
                                            <div class="flex justify-between w-full"><h4 class="font-bold text-sm">${j.title}</h4><span class="text-xs bg-green-100 px-2 rounded text-green-700">${j.salary}</span></div>
                                            <div class="text-xs text-slate-500 mt-1">${j.email}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            });
            updateActionState();
        }
        
        // ... (ä¿ç•™ toggleDropdown, selectJob, toggleSingleSelection, toggleGroupSelection, toggleSelectAll, clearAllSelections, updateGroupUI, updateActionState, setupEventListeners) ...
        // ä¸ºäº†ç¡®ä¿ä»£ç å®Œæ•´è¿è¡Œï¼Œä½ éœ€è¦æŠŠä¹‹å‰é‚£æ®µå®Œå–„çš„äº¤äº’ JS é€»è¾‘å¤åˆ¶å›æ¥è¦†ç›–è¿™é‡Œçœç•¥çš„éƒ¨åˆ†ã€‚
        // ä¸‹é¢æ˜¯æ–°å¢çš„ Modal é€»è¾‘

        function toggleDropdown(id) { document.getElementById(`dropdown-${id}`).classList.toggle('open'); }
        
        function selectJob(e, sid, jid) {
            let job = null;
            for(let c in groupedJobs) { let f = groupedJobs[c].find(x=>String(x.id)==String(jid)); if(f){job=f;break;} }
            if(job) {
                document.getElementById(`dt-${sid}`).innerText = job.title;
                document.getElementById(`dc-${sid}`).innerText = (job.raw_content||"").replace(/[#ï¼ƒ]/g,'');
                document.querySelectorAll(`#dropdown-${sid} .job-item`).forEach(el=>el.classList.remove('active'));
                document.getElementById(`job-row-${jid}`).classList.add('active');
            }
        }

        window.toggleSingleSelection = (id, chk, sid) => {
            const sId = String(id);
            chk ? selectedIds.add(sId) : selectedIds.delete(sId);
            const row = document.getElementById(`job-row-${sId}`);
            if(row) chk ? row.classList.add('selected') : row.classList.remove('selected');
            updateGroupUI(sid); updateActionState();
        };

        window.toggleGroupSelection = (c, chk, sid) => {
            groupedJobs[c].forEach(j => {
                const sId = String(j.id);
                chk ? selectedIds.add(sId) : selectedIds.delete(sId);
                const el = document.getElementById(`job-chk-${sId}`); if(el) el.checked=chk;
                const row = document.getElementById(`job-row-${sId}`); if(row) chk ? row.classList.add('selected') : row.classList.remove('selected');
            });
            updateGroupUI(sid); updateActionState();
        }

        function updateGroupUI(sid) {
            const p = document.getElementById(`dropdown-${sid}`); if(!p)return;
            const all = p.querySelectorAll('input[type=checkbox]').length;
            const chk = p.querySelectorAll('input[type=checkbox]:checked').length;
            document.getElementById(`group-count-${sid}`).innerText = `å·²é€‰ ${chk}`;
            document.getElementById(`group-count-${sid}`).classList.toggle('hidden', chk===0);
            const g = document.getElementById(`group-chk-${sid}`);
            if(g) { g.checked = chk===all && all>0; g.indeterminate = chk>0 && chk<all; }
        }

        function toggleSelectAll() {
            const all = Object.values(groupedJobs).flat();
            const isAll = all.every(j=>selectedIds.has(String(j.id)));
            if(isAll) all.forEach(j=>selectedIds.delete(String(j.id)));
            else all.forEach(j=>selectedIds.add(String(j.id)));
            renderJobs();
        }
        function clearAllSelections() { selectedIds.clear(); renderJobs(); }
        function updateActionState() {
            const n = selectedIds.size;
            document.getElementById('selectedCount').innerText = n;
            const btn = document.getElementById('applyBtn');
            if(n>0 && resumeFile) { btn.disabled=false; btn.className="w-full py-2.5 px-4 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg transition-all"; btn.innerText=`æŠ•é€’ (${n})`; }
            else { btn.disabled=true; btn.className="w-full py-2.5 px-4 rounded-lg font-bold text-white bg-slate-300 cursor-not-allowed"; btn.innerText="ä¸€é”®æŠ•é€’"; }
        }
        function setupEventListeners() {
            document.getElementById('resumeInput').addEventListener('change', (e)=>{
                if(e.target.files[0]){ resumeFile=e.target.files[0]; document.getElementById('uploadPlaceholder').classList.add('hidden'); document.getElementById('fileInfo').classList.remove('hidden'); document.getElementById('fileName').innerText=resumeFile.name; updateActionState(); }
            });
            ['searchInput','categorySelect'].forEach(id=>document.getElementById(id).addEventListener('input', renderJobs));
        }

        // --- æ–°å¢ Modal é€»è¾‘ ---
        function showConfigModal() { document.getElementById('config-modal').classList.remove('hidden'); }
        function closeConfigModal() { document.getElementById('config-modal').classList.add('hidden'); }
        
        function updateSmtpConfig() {
            const type = document.getElementById('smtpProvider').value;
            const hostEl = document.getElementById('smtpHost');
            const portEl = document.getElementById('smtpPort');
            const userEl = document.getElementById('smtpUser');
            
            if(type === 'qq') { hostEl.value = 'smtp.qq.com'; portEl.value = '587'; userEl.placeholder = 'ä¾‹å¦‚: 123456@qq.com'; }
            else if(type === 'gmail') { hostEl.value = 'smtp.gmail.com'; portEl.value = '587'; userEl.placeholder = 'ä¾‹å¦‚: user@gmail.com'; }
            else if(type === '163') { hostEl.value = 'smtp.163.com'; portEl.value = '25'; userEl.placeholder = 'ä¾‹å¦‚: user@163.com'; }
            else { hostEl.readOnly = false; portEl.readOnly = false; hostEl.value = ''; portEl.value = ''; }
        }

        async function startRealApplying() {
            closeConfigModal();
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('sending-view').classList.remove('hidden');
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="text-center p-10 text-gray-500 animate-pulse">æ­£åœ¨è¿æ¥é‚®ä»¶æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...</div>';
            
            const formData = new FormData();
            formData.append('resume', resumeFile);
            formData.append('jobIds', JSON.stringify(Array.from(selectedIds)));
            formData.append('smtp_user', document.getElementById('smtpUser').value);
            formData.append('smtp_pass', document.getElementById('smtpPass').value);
            formData.append('smtp_host', document.getElementById('smtpHost').value);
            formData.append('smtp_port', document.getElementById('smtpPort').value);

            try {
                const response = await fetch(`${API_BASE_URL}/send-resume`, { method: 'POST', body: formData });
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressTitle').innerText = "ä»»åŠ¡å®Œæˆ";
                    logContainer.innerHTML = `
                        <div class="p-8 text-center bg-green-50 rounded-xl m-4">
                            <div class="text-green-600 font-bold text-2xl mb-2">ğŸ‰ å‘é€æˆåŠŸ</div>
                            <div class="text-slate-600">æˆåŠŸ: ${result.sent} å° | å¤±è´¥: ${result.failed} å°</div>
                            <button onclick="resetView()" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">è¿”å›åˆ—è¡¨</button>
                        </div>`;
                } else { throw new Error(result.msg); }
            } catch (error) {
                document.getElementById('progressBar').classList.add('bg-red-500');
                logContainer.innerHTML = `
                    <div class="p-8 text-center bg-red-50 rounded-xl m-4">
                        <div class="text-red-600 font-bold text-lg mb-2">âŒ å‘é€å¤±è´¥</div>
                        <div class="text-slate-500 mb-4">${error.message}</div>
                        <button onclick="resetView()" class="px-4 py-2 bg-slate-200 rounded-lg">è¿”å›</button>
                    </div>`;
            }
        }
        
        function resetView() {
            document.getElementById('sending-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').classList.remove('bg-red-500');
        }
    </script>
</body>

</html>
