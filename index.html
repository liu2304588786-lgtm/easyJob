<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeJob æ‹›è˜èšåˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* åŠ å¯†ç§‘æŠ€é£æ ¼èƒŒæ™¯ */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* åŠ¨æ€ç½‘æ ¼èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 25s linear infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        /* å¤´éƒ¨æ ·å¼ */
        header { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(59, 130, 246, 0.2); }
        
        /* æœç´¢æ ç»ç’ƒæ‹Ÿæ€ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        /* å…¬å¸å¡ç‰‡æ ·å¼ */
        .company-card {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .company-card:hover {
            border-left-color: #3b82f6;
            transform: translateX(2px);
            background-color: rgba(255, 255, 255, 1) !important;
        }
        
        /* ä¸‹æ‹‰åˆ—è¡¨åŠ¨ç”» */
        .job-dropdown {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .job-dropdown.open {
            max-height: 2000px; /* å¢åŠ é«˜åº¦ä»¥å®¹çº³æ›´å¤šå†…å®¹ */
            opacity: 1;
        }
        
        /* æ—‹è½¬ç®­å¤´ */
        .arrow-icon { transition: transform 0.3s ease; }
        .arrow-icon.rotate { transform: rotate(180deg); }

    </style>
</head>
<body class="font-sans text-slate-900 pb-20">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg">
                    <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </div>
                <span class="font-bold text-xl tracking-tight">DeJob <span class="text-blue-400 font-light">Aggregator</span></span>
            </div>
            <div class="flex items-center gap-4 text-sm text-slate-400">
                <span class="hidden sm:inline">æ•°æ®æº: t.me/DeJob_official</span>
                <div class="flex items-center gap-1">
                    <div id="statusIndicator" class="h-2 w-2 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span id="statusText" class="text-xs">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-4" style="min-height: calc(100vh - 56px);">
        <div id="main-view" class="flex flex-col lg:flex-row gap-6 h-full">
            
            <!-- å·¦ä¾§ï¼šèŒä½åˆ—è¡¨ -->
            <div class="flex-1 flex flex-col h-full overflow-hidden">
                <!-- ç­›é€‰æ  -->
                <div class="glass-panel p-3 rounded-xl shadow-sm mb-3 sticky top-0 z-40">
                    <div class="flex flex-col md:flex-row gap-3 justify-between items-center">
                        <div class="relative w-full md:w-1/3">
                            <svg class="absolute left-3 top-2.5 h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            <input type="text" id="searchInput" placeholder="æœç´¢å…¬å¸ã€å²—ä½..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div class="flex gap-2 w-full md:w-auto overflow-x-auto">
                            <select id="categorySelect" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 focus:outline-none cursor-pointer">
                                <option value="All">æ‰€æœ‰å²—ä½</option>
                                <option value="Dev">å¼€å‘ (Dev)</option>
                                <option value="Marketing">å¸‚åœº (Marketing)</option>
                            </select>
                            <select id="typeSelect" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 focus:outline-none cursor-pointer">
                                <option value="All">æ‰€æœ‰æ–¹å¼</option>
                                <option value="å…¨èŒ">å…¨èŒ</option>
                                <option value="è¿œç¨‹">è¿œç¨‹</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ  -->
                <div class="flex justify-between items-center mb-2 px-1 text-white/80">
                    <button onclick="toggleSelectAll()" id="selectAllBtn" class="text-sm font-medium text-blue-400 hover:text-blue-300 transition-colors">å…¨é€‰æœ¬é¡µ</button>
                    <span id="jobCount" class="text-xs">åŠ è½½ä¸­...</span>
                </div>

                <!-- èŒä½åˆ—è¡¨å®¹å™¨ (æ»šåŠ¨åŒºåŸŸ) -->
                <div id="jobList" class="flex-1 overflow-y-auto space-y-3 pb-10 pr-1">
                    <div class="text-center py-10 text-slate-400 animate-pulse">æ­£åœ¨ä»åç«¯è·å–æ•°æ®...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
            <div class="w-full lg:w-80 flex-shrink-0">
                <div class="glass-panel p-4 rounded-xl sticky top-4">
                    <h2 class="text-base font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <svg class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                        æŠ•é€’åŠ©æ‰‹
                    </h2>

                    <!-- ç®€å†ä¸Šä¼  -->
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ ç®€å† (PDF)</label>
                        <div class="relative group">
                            <input type="file" id="resumeInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-lg p-3 text-center transition-colors bg-slate-50 group-hover:border-blue-400">
                                <div id="uploadPlaceholder">
                                    <svg class="h-6 w-6 mx-auto mb-2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                    <p class="text-sm text-slate-500">ç‚¹å‡»ä¸Šä¼ </p>
                                </div>
                                <div id="fileInfo" class="hidden flex items-center justify-center gap-2 text-green-700">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    <span id="fileName" class="text-sm font-medium truncate max-w-[150px]"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-slate-600">å·²é€‰å²—ä½</span>
                            <span id="selectedCount" class="text-xl font-bold text-blue-600">0</span>
                        </div>
                        <button id="clearBtn" onclick="clearAllSelections()" class="w-full py-1.5 px-3 rounded text-xs font-bold text-slate-500 bg-slate-200 hover:bg-slate-300 transition-colors">
                            æ¸…ç©ºé€‰æ‹©
                        </button>
                    </div>

                    <button id="applyBtn" onclick="startApplying()" disabled class="w-full py-2.5 px-4 rounded-lg font-bold text-white shadow-lg transition-all bg-slate-300 cursor-not-allowed text-sm">
                        ä¸€é”®æŠ•é€’
                    </button>
                </div>
            </div>
        </div>

        <!-- è¿›åº¦è§†å›¾ -->
        <div id="sending-view" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden mt-10">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800" id="progressTitle">æŠ•é€’ä»»åŠ¡é˜Ÿåˆ—</h2>
                <button onclick="resetView()" class="text-sm text-blue-600 hover:underline">è¿”å›åˆ—è¡¨</button>
            </div>
            <div class="h-1.5 w-full bg-slate-100">
                <div id="progressBar" class="h-full bg-green-500 transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
            <div id="logContainer" class="max-h-[500px] overflow-y-auto p-0"></div>
        </div>
    </main>

    <script>
        // å…œåº•æ•°æ®
        const FALLBACK_JOBS = [
            { id: 1, company: "Marisa", title: "Solidity Engineer", salary: "1800U", date: "2023-11-01", email: "hr@marisa.io", tags: ["Dev", "Remote"], raw_content: "#Marisa\nDeFi Project recruiting...\nWe need solidity dev." },
            { id: 2, company: "Marisa", title: "Marketing Manager", salary: "2000U", date: "2023-11-01", email: "hr@marisa.io", tags: ["Marketing"], raw_content: "#Marisa\nDeFi Project recruiting...\nWe need marketing manager." },
            { id: 3, company: "GameFi Studio", title: "Community Mod", salary: "500U", date: "2023-10-23", email: "jobs@gamefi.com", tags: ["Community"], raw_content: "GameFi Studio hiring mods." },
        ];

        let currentJobs = [];
        let groupedJobs = {}; 
        let selectedIds = new Set();
        let resumeFile = null;
        const API_BASE_URL = 'http://localhost:5000/api'; 

        document.addEventListener('DOMContentLoaded', () => {
            loadJobsData();
            setupEventListeners();
        });

        async function loadJobsData() {
            const statusText = document.getElementById('statusText');
            const indicator = document.getElementById('statusIndicator');

            try {
                const response = await fetch(`${API_BASE_URL}/jobs`);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    currentJobs = data;
                    indicator.className = "h-2 w-2 rounded-full bg-green-500 animate-pulse";
                    statusText.innerText = "Live Connected";
                } else {
                    currentJobs = [...FALLBACK_JOBS];
                    statusText.innerText = "Live (Empty)";
                }
            } catch (error) {
                console.warn("Fallback mode", error);
                currentJobs = [...FALLBACK_JOBS];
                indicator.className = "h-2 w-2 rounded-full bg-slate-400";
                statusText.innerText = "Demo Mode";
            }
            renderJobs();
        }

        function renderJobs() {
            const listEl = document.getElementById('jobList');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const catVal = document.getElementById('categorySelect').value;

            // 1. ç­›é€‰
            const filtered = currentJobs.filter(job => {
                const text = (job.company + job.title + job.raw_content).toLowerCase();
                const matchSearch = !searchVal || text.includes(searchVal);
                const matchCat = catVal === 'All' || (job.tags||[]).some(t => t.includes(catVal));
                return matchSearch && matchCat;
            });

            // 2. åˆ†ç»„ï¼šæŒ‰ Company èšåˆ
            groupedJobs = filtered.reduce((acc, job) => {
                // æ¸…æ´—å…¬å¸åï¼Œå»æ‰ #æ ‡ç­¾
                let cleanCompany = (job.company || "å…¶ä»–é¡¹ç›®").replace(/#.*/, '').trim();
                cleanCompany = cleanCompany.replace(/[^\w\s\u4e00-\u9fa5]/g, '').trim();
                if (!cleanCompany) cleanCompany = "å…¶ä»–é¡¹ç›®";

                if (!acc[cleanCompany]) acc[cleanCompany] = [];
                acc[cleanCompany].push(job);
                return acc;
            }, {});

            // 3. æ¸²æŸ“
            document.getElementById('jobCount').innerText = `å…± ${Object.keys(groupedJobs).length} ä¸ªé¡¹ç›®ï¼Œ${filtered.length} ä¸ªå²—ä½`;
            listEl.innerHTML = '';

            if (Object.keys(groupedJobs).length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 text-slate-400">æ— åŒ¹é…ç»“æœ</div>`;
                return;
            }

            Object.keys(groupedJobs).forEach(company => {
                const jobs = groupedJobs[company];
                const latestDate = jobs[0].date || "";
                // æå–å…¬å¸ç®€ä»‹ (å–ç¬¬ä¸€æ¡æ•°æ®çš„åŸå§‹å†…å®¹ï¼Œåšç®€å•æˆªæ–­)
                const introText = (jobs[0].raw_content || "æš‚æ— ç®€ä»‹").substring(0, 300) + "...";
                
                const isGroupSelected = jobs.every(j => selectedIds.has(j.id));
                const selectedCountInGroup = jobs.filter(j => selectedIds.has(j.id)).length;
                
                const groupCard = document.createElement('div');
                groupCard.className = "company-card bg-white/95 backdrop-blur-sm rounded-xl border border-slate-200/50 overflow-hidden shadow-sm";
                
                const safeId = company.replace(/[^a-zA-Z0-9]/g, '_') + Math.floor(Math.random() * 1000);
                
                groupCard.innerHTML = `
                    <!-- å…¬å¸å¤´éƒ¨ -->
                    <div class="p-4 cursor-pointer flex justify-between items-center bg-slate-50/80 hover:bg-slate-100 transition-colors" 
                         onclick="toggleDropdown('${safeId}')">
                        <div class="flex items-center gap-4">
                            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-xl shadow-md">
                                ${company.substring(0, 1).toUpperCase()}
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg tracking-tight">${company}</h3>
                                <div class="text-xs text-slate-500 flex items-center gap-2 mt-0.5">
                                    <span class="bg-white/50 px-2 py-0.5 rounded border border-slate-200/50">${jobs.length} ä¸ªå²—ä½</span>
                                    <span class="text-slate-400">â€¢ ${latestDate}</span>
                                    ${selectedCountInGroup > 0 ? `<span class="text-blue-600 font-bold ml-1">å·²é€‰ ${selectedCountInGroup}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 mr-2" onclick="event.stopPropagation()">
                                <label for="group-chk-${safeId}" class="text-xs font-medium text-slate-500 cursor-pointer select-none">å…¨é€‰</label>
                                <input type="checkbox" id="group-chk-${safeId}" 
                                       ${isGroupSelected ? 'checked' : ''} 
                                       onchange="toggleGroupSelection('${company}', this.checked)"
                                       class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                            </div>
                            <div class="h-8 w-8 rounded-full bg-white flex items-center justify-center border border-slate-200 shadow-sm">
                                <svg id="arrow-${safeId}" class="arrow-icon h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸‹æ‹‰å†…å®¹åŒº (å·¦å³å¸ƒå±€) -->
                    <div id="dropdown-${safeId}" class="job-dropdown bg-white border-t border-slate-100">
                        <div class="flex flex-col md:flex-row gap-0 md:gap-4 p-0 md:p-4">
                            
                            <!-- å·¦ä¾§ï¼šå…¬å¸ç®€ä»‹ (35%) -->
                            <div class="md:w-[35%] bg-slate-50/50 p-4 rounded-lg border border-slate-100/50 mb-2 md:mb-0">
                                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">å…¬å¸ç®€ä»‹ / Company Intro</h4>
                                <p class="text-sm text-slate-600 leading-relaxed whitespace-pre-line font-sans">${introText}</p>
                            </div>

                            <!-- å³ä¾§ï¼šå²—ä½åˆ—è¡¨ (65%) -->
                            <div class="md:w-[65%] space-y-2">
                                ${jobs.map(job => {
                                    const isSel = selectedIds.has(job.id);
                                    // å‰ç«¯æ¸…æ´—å²—ä½åç§°ï¼Œå»é™¤#
                                    let cleanTitle = (job.title || "å²—ä½è¯¦æƒ…").replace(/#.*/, '').trim();
                                    return `
                                    <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-blue-50/50 transition-colors border border-slate-100 hover:border-blue-200 bg-white">
                                        <input type="checkbox" value="${job.id}" ${isSel ? 'checked' : ''}
                                               onchange="toggleSingleSelection(${job.id}, this.checked)"
                                               class="mt-1.5 h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 flex-shrink-0 cursor-pointer">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-start mb-1">
                                                <!-- å²—ä½åç§° (æ ‡é¢˜) - å¼ºåˆ¶æ—  # -->
                                                <h4 class="font-bold text-sm text-slate-800 flex-1 mr-2">${cleanTitle}</h4>
                                                <span class="text-[10px] font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded-full whitespace-nowrap shadow-sm border border-green-200">${job.salary}</span>
                                            </div>
                                            
                                            <div class="text-xs text-slate-500 flex items-center gap-2 mb-2">
                                                <span class="text-blue-600 font-medium break-all bg-blue-50 px-1.5 py-0.5 rounded border border-blue-100">ğŸ“§ ${job.email}</span>
                                            </div>

                                            <div class="flex flex-wrap gap-1.5">
                                                ${(job.tags||[]).map(t => `<span class="px-1.5 py-0.5 rounded text-[10px] bg-slate-100 text-slate-600 border border-slate-200">#${t}</span>`).join('')}
                                            </div>
                                            
                                            <!-- å·²ç§»é™¤ åŸå§‹å†…å®¹é¢„è§ˆ (Intro) -->
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(groupCard);
            });
            updateActionState();
        }

        function toggleDropdown(id) {
            const dropdown = document.getElementById(`dropdown-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if (dropdown.classList.contains('open')) {
                dropdown.classList.remove('open');
                arrow.classList.remove('rotate');
            } else {
                dropdown.classList.add('open');
                arrow.classList.add('rotate');
            }
        }

        window.toggleGroupSelection = (companyName, isChecked) => {
            const jobs = groupedJobs[companyName];
            jobs.forEach(job => {
                isChecked ? selectedIds.add(job.id) : selectedIds.delete(job.id);
            });
            renderJobs();
        };

        window.toggleSingleSelection = (id, isChecked) => {
            isChecked ? selectedIds.add(id) : selectedIds.delete(id);
            renderJobs();
        };

        function toggleSelectAll() {
            const allJobs = Object.values(groupedJobs).flat();
            const allSelected = allJobs.every(j => selectedIds.has(j.id));
            if (allSelected) {
                allJobs.forEach(j => selectedIds.delete(j.id));
            } else {
                allJobs.forEach(j => selectedIds.add(j.id));
            }
            renderJobs();
        }

        function clearAllSelections() {
            selectedIds.clear();
            renderJobs();
        }

        function updateActionState() {
            const count = selectedIds.size;
            document.getElementById('selectedCount').innerText = count;
            const btn = document.getElementById('applyBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            if (count > 0 && resumeFile) {
                btn.disabled = false;
                btn.className = "w-full py-2.5 px-4 rounded-lg font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg hover:-translate-y-0.5 transition-all";
                btn.innerText = `æŠ•é€’ (${count})`;
            } else {
                btn.disabled = true;
                btn.className = "w-full py-2.5 px-4 rounded-lg font-bold text-white bg-slate-300 cursor-not-allowed";
                btn.innerText = "ä¸€é”®æŠ•é€’";
            }

            if (count > 0) {
                clearBtn.className = "w-full py-1.5 px-3 rounded text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-sm transition-colors mb-2";
            } else {
                clearBtn.className = "w-full py-1.5 px-3 rounded text-xs font-bold text-slate-500 bg-slate-200 hover:bg-slate-300 transition-colors mb-2";
            }
        }

        function setupEventListeners() {
            const resumeInput = document.getElementById('resumeInput');
            if (resumeInput) {
                resumeInput.addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        resumeFile = e.target.files[0];
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                        document.getElementById('fileInfo').classList.remove('hidden');
                        document.getElementById('fileName').innerText = resumeFile.name;
                        updateActionState();
                    }
                });
            }
            ['searchInput', 'categorySelect'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', renderJobs);
            });
        }

        async function startApplying() {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('sending-view').classList.remove('hidden');
            const log = document.getElementById('logContainer');
            log.innerHTML = '';
            
            const targets = currentJobs.filter(j => selectedIds.has(j.id));
            let done = 0;

            for (const job of targets) {
                await new Promise(r => setTimeout(r, 500));
                done++;
                document.getElementById('progressBar').style.width = `${(done/targets.length)*100}%`;
                
                const div = document.createElement('div');
                div.className = "p-3 border-b border-slate-50 flex justify-between items-center text-sm fade-in";
                div.innerHTML = `<span class="text-green-600 font-bold">âœ” Sent to ${job.company}</span> <span class="text-slate-500">${job.email}</span>`;
                log.prepend(div);
            }
            document.getElementById('progressTitle').innerText = "æŠ•é€’å®Œæˆ";
        }
        
        function resetView() {
            document.getElementById('sending-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        }
    </script>
</body>
</html>