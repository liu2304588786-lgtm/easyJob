<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeJob æ‹›è˜èšåˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* åŠ å¯†ç§‘æŠ€é£æ ¼èƒŒæ™¯ */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            min-height: 100vh;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* åŠ¨æ€ç½‘æ ¼èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.08) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 25s linear infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        /* æ¸å˜å…‰æ•ˆ */
        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
            animation: gradientRotate 20s ease infinite;
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
        }

        @keyframes gradientRotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        /* å†…å®¹å±‚æå‡ */
        header, main {
            position: relative;
            z-index: 10;
        }

        /* æœç´¢æ å®¹å™¨æ ·å¼ */
        .search-container {
            padding-bottom: 15px !important;
            margin-bottom: 10px !important;
        }

        /* æœç´¢æ æ ·å¼ */
        .search-bar {
            margin-bottom: 0 !important;
        }

        /* å²—ä½å¡ç‰‡æ ·å¼ */
        .job-card {
            margin-bottom: 5px !important;
            padding: 8px 12px !important;
        }

        /* å¤é€‰æ¡†æ ·å¼å’Œå¯¹é½ */
        .job-card input[type="checkbox"] {
            margin-top: 2px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .job-card label {
            cursor: pointer;
            user-select: none;
        }

        /* ç¡®ä¿å¤é€‰æ¡†å’Œå†…å®¹å¯¹é½ */
        .job-checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        /* ç¬¬ä¸€ä¸ªå²—ä½å¡ç‰‡çš„ä¸Šè¾¹è· */
        #jobList > .job-card:first-child {
            margin-top: 10px !important;
        }

        /* èŒä½åˆ—è¡¨å®¹å™¨ - å¯æ»šåŠ¨ */
        #jobList {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            margin-top: 0;
        }

        /* å²—ä½åˆ—è¡¨å®¹å™¨ï¼Œç›´æ¥åŠ é¡¶éƒ¨å†…è¾¹è· */
        .job-list {
            padding-top: 30px !important; /* !importantå¼ºåˆ¶è¦†ç›–åŸæœ‰æ ·å¼ */
        }

        /* ç¡®ä¿ä¸»å®¹å™¨é«˜åº¦é€‚é…ä¸€å± */
        #main-view {
            height: calc(100vh - 70px);
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        /* å·¦ä¾§èŒä½åˆ—è¡¨åŒºåŸŸ */
        #main-view > .flex-1 {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
    </style>
</head>
<body class="font-sans text-slate-900 pb-20">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-slate-900/95 backdrop-blur-sm text-white shadow-lg sticky top-0 z-50 border-b border-blue-500/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg">
                    <!-- SVG Icon: Send -->
                    <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </div>
                <span class="font-bold text-xl tracking-tight">DeJob <span class="text-blue-400 font-light">Aggregator</span></span>
            </div>
            <div class="flex items-center gap-4 text-sm text-slate-400">
                <span class="hidden sm:inline">æ•°æ®æº: t.me/DeJob_official</span>
                <div class="flex items-center gap-1">
                    <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                    <div id="statusIndicator" class="h-2 w-2 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span id="statusText" class="text-xs">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-2" style="height: calc(100vh - 56px);">
        
        <!-- è§†å›¾å®¹å™¨ -->
        <div id="main-view" class="flex flex-col lg:flex-row gap-6">
            
            <!-- å·¦ä¾§ï¼šèŒä½åˆ—è¡¨ -->
            <div class="flex-1">
                
                <!-- ç­›é€‰æ  -->
                <div class="search-container search-bar bg-white/95 backdrop-blur-sm p-3 rounded-xl shadow-sm border border-slate-200/50 mb-3 sticky top-16 z-40">
                    <div class="flex flex-col md:flex-row gap-3 justify-between items-center">
                        <!-- æœç´¢ -->
                        <div class="relative w-full md:w-1/3">
                            <svg class="absolute left-3 top-2.5 h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            <input type="text" id="searchInput" placeholder="æœç´¢èŒä½ã€å…¬å¸..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-all">
                        </div>
                        
                        <!-- ä¸‹æ‹‰ç­›é€‰ -->
                        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                            <select id="categorySelect" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 focus:outline-none cursor-pointer">
                                <option value="All">æ‰€æœ‰å²—ä½</option>
                                <option value="Dev">å¼€å‘ (Dev)</option>
                                <option value="Design">è®¾è®¡ (Design)</option>
                                <option value="Marketing">å¸‚åœº (Marketing)</option>
                                <option value="Operation">è¿è¥ (Operation)</option>
                            </select>
                            <select id="typeSelect" class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 focus:outline-none cursor-pointer">
                                <option value="All">æ‰€æœ‰æ–¹å¼</option>
                                <option value="å…¨èŒ">å…¨èŒ</option>
                                <option value="å…¼èŒ">å…¼èŒ</option>
                                <option value="è¿œç¨‹">è¿œç¨‹</option>
                                <option value="å®ä¹ ">å®ä¹ </option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- åˆ—è¡¨å¤´éƒ¨ -->
                <div class="flex justify-between items-center mb-2 px-1">
                    <button onclick="toggleSelectAll()" id="selectAllBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                        å…¨é€‰æœ¬é¡µ
                    </button>
                    <span id="jobCount" class="text-xs text-slate-400">åŠ è½½ä¸­...</span>
                </div>

                <!-- èŒä½åˆ—è¡¨å®¹å™¨ -->
                <div id="jobList" class="job-list">
                    <!-- JS å°†åœ¨è¿™é‡ŒåŠ¨æ€æ¸²æŸ“èŒä½å¡ç‰‡ -->
                    <div class="text-center py-10 text-slate-400 animate-pulse">æ­£åœ¨ä»åç«¯è·å–æ•°æ®...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šä¾§è¾¹æ  (æ“ä½œåŒº) -->
            <div class="w-full lg:w-80 flex-shrink-0">
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-sm border border-slate-200/50 p-4 sticky top-16">
                    <h2 class="text-base font-bold text-slate-800 mb-3 flex items-center gap-2">
                        <svg class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                        æŠ•é€’åŠ©æ‰‹
                    </h2>

                    <!-- ç®€å†ä¸Šä¼ åŒºåŸŸ -->
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ ç®€å† (PDF)</label>
                        <div class="relative group">
                            <input type="file" id="resumeInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-lg p-3 text-center transition-colors bg-slate-50 group-hover:border-blue-400">
                                <!-- æœªä¸Šä¼ çŠ¶æ€ -->
                                <div id="uploadPlaceholder">
                                    <svg class="h-6 w-6 mx-auto mb-2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                    <p class="text-sm text-slate-500">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ </p>
                                </div>
                                <!-- å·²ä¸Šä¼ çŠ¶æ€ (é»˜è®¤éšè—) -->
                                <div id="fileInfo" class="hidden flex items-center justify-center gap-2 text-green-700">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    <span id="fileName" class="text-sm font-medium truncate max-w-[150px]"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é€‰ä¸­ç»Ÿè®¡ -->
                    <div class="mb-4">
                        <label class="block text-xs font-medium text-slate-700 mb-1.5">ç¬¬äºŒæ­¥ï¼šé€‰æ‹©èŒä½</label>
                        <div class="bg-slate-50 rounded-lg p-2.5 flex justify-between items-center border border-slate-100">
                            <span class="text-sm text-slate-600">å·²é€‰èŒä½</span>
                            <span id="selectedCount" class="text-xl font-bold text-blue-600">0</span>
                        </div>
                    </div>

                    <!-- æ¸…é™¤æŒ‰é’® -->
                    <button id="clearBtn" onclick="clearAllSelections()" class="w-full py-2.5 px-4 rounded-lg font-bold text-white shadow-lg transition-all bg-slate-300 cursor-pointer text-sm mb-2 hover:bg-slate-400">
                        ä¸€é”®æ¸…é™¤
                    </button>

                    <!-- æŠ•é€’æŒ‰é’® -->
                    <button id="applyBtn" onclick="startApplying()" disabled class="w-full py-2.5 px-4 rounded-lg font-bold text-white shadow-lg shadow-blue-500/30 transition-all bg-slate-300 cursor-not-allowed text-sm">
                        ä¸€é”®æŠ•é€’
                    </button>
                    <p class="mt-2 text-xs text-slate-400 text-center">æç¤ºï¼šç³»ç»Ÿå°†è‡ªåŠ¨è§£æèŒä½é‚®ç®±å¹¶å‘é€ç®€å†ã€‚</p>
                </div>
            </div>
        </div>

        <!-- å‘é€è¿›åº¦è§†å›¾ (é»˜è®¤éšè—) -->
        <div id="sending-view" class="hidden max-w-2xl mx-auto bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800" id="progressTitle">æŠ•é€’ä»»åŠ¡é˜Ÿåˆ—</h2>
                <button onclick="resetView()" class="text-sm text-blue-600 hover:underline">è¿”å›åˆ—è¡¨</button>
            </div>
            
            <div class="h-1.5 w-full bg-slate-100">
                <div id="progressBar" class="h-full bg-green-500 transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>

            <div id="logContainer" class="max-h-[500px] overflow-y-auto p-0">
                <!-- æ—¥å¿—å°†æ’å…¥è¿™é‡Œ -->
            </div>
        </div>

    </main>

    <!-- JavaScript é€»è¾‘ -->
    <script>
        // --- æ¼”ç¤º/å…œåº•æ•°æ® (å½“åç«¯æ–­å¼€æ—¶ä½¿ç”¨) ---
        // è¿™é‡Œçš„ title ä½¿ç”¨äº† "Marisa" è¿™ç§é¡¹ç›®åæ ¼å¼ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„ "Solidity Engineer"
        const FALLBACK_JOBS = [
            { id: 1, title: "Marisa (ç¤ºä¾‹)", company: "DeFi Protocol X", type: "å…¨èŒ", location: "è¿œç¨‹ (Global)", tags: ["Dev", "Solidity"], salary: "1800U", date: "2023-11-01", email: "hr@marisa-project.io", source: "Mock Data" },
            { id: 2, title: "GameFi Studio", company: "GameFi Studio", type: "å…¼èŒ", location: "è¿œç¨‹ (APAC)", tags: ["Marketing"], salary: "2000U", date: "2023-10-23", email: "jobs@very-long-domain-name-example.com", source: "Mock Data" },
        ];

        // --- çŠ¶æ€ç®¡ç† ---
        let currentJobs = [];
        let selectedIds = new Set();
        let resumeFile = null;
        // åç«¯ API åœ°å€
        const API_BASE_URL = 'http://localhost:5000/api'; 

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadJobsData(); // å°è¯•åŠ è½½çœŸå®æ•°æ®
            setupEventListeners();
        });

        // --- æ•°æ®åŠ è½½æ ¸å¿ƒé€»è¾‘ (å«é”™è¯¯å¤„ç†) ---
        async function loadJobsData() {
            const listEl = document.getElementById('jobList');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');

            try {
                // 1. å°è¯•ä» Python åç«¯è·å–æ•°æ®
                const response = await fetch(`${API_BASE_URL}/jobs`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    currentJobs = data;
                    console.log("æˆåŠŸè¿æ¥åç«¯ï¼ŒåŠ è½½äº†", data.length, "æ¡æ•°æ®");
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ï¼šç»¿è‰² (Live)
                    statusIndicator.className = "h-2 w-2 rounded-full bg-green-500 animate-pulse";
                    statusText.innerText = "Live Connected";
                } else {
                    console.log("åç«¯è¿”å›ç©ºæ•°æ®ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®");
                    currentJobs = [...FALLBACK_JOBS];
                    statusText.innerText = "Live (Empty)";
                }

            } catch (error) {
                // 2. å¦‚æœè¿æ¥å¤±è´¥ï¼ˆæŠ¥é”™ï¼‰ï¼Œå›é€€åˆ°æ¼”ç¤ºæ•°æ®
                console.warn("è¿æ¥åç«¯å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼ã€‚é”™è¯¯è¯¦æƒ…:", error);
                
                currentJobs = [...FALLBACK_JOBS];
                
                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ï¼šç°è‰² (Demo Mode)
                statusIndicator.className = "h-2 w-2 rounded-full bg-slate-400";
                statusText.innerText = "Demo Mode";
            }
            
            renderJobs();
        }
        
        // æ¸²æŸ“èŒä½åˆ—è¡¨
        function renderJobs() {
            const listEl = document.getElementById('jobList');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const catVal = document.getElementById('categorySelect').value;
            const typeVal = document.getElementById('typeSelect').value;

            // ç­›é€‰
            const filteredJobs = currentJobs.filter(job => {
                const title = (job.title || "").toLowerCase();
                const company = (job.company || "").toLowerCase();
                const raw = (job.raw_content || "").toLowerCase(); // å…è®¸æœç´¢åŸå§‹å†…å®¹
                const tags = Array.isArray(job.tags) ? job.tags : [];
                const type = job.type || "";

                const matchSearch = !searchVal || title.includes(searchVal) || company.includes(searchVal) || raw.includes(searchVal);
                const matchCat = catVal === 'All' || tags.some(t => t.includes(catVal));
                const matchType = typeVal === 'All' || type.includes(typeVal);
                return matchSearch && matchCat && matchType;
            });

            // æ›´æ–° UI ç»Ÿè®¡
            document.getElementById('jobCount').innerText = `æ˜¾ç¤º ${filteredJobs.length} æ¡æ•°æ®`;
            
            // æ¸…ç©ºåˆ—è¡¨
            listEl.innerHTML = '';

            if (filteredJobs.length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 text-slate-400">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èŒä½</div>`;
                // å³ä½¿åˆ—è¡¨ä¸ºç©ºï¼Œä¹Ÿè¦æ›´æ–°é€‰ä¸­è®¡æ•°ï¼ˆå¯èƒ½è¿˜æœ‰å·²é€‰ä¸­çš„å²—ä½åœ¨ç­›é€‰èŒƒå›´å¤–ï¼‰
                updateSelectedCount();
                updateActionState();
                return;
            }

            // ç”Ÿæˆ HTML
            filteredJobs.forEach(job => {
                const isSelected = selectedIds.has(job.id);
                const card = document.createElement('div');
                card.className = `job-card fade-in group relative bg-white/95 backdrop-blur-sm rounded-xl border transition-all duration-200 hover:shadow-md border-slate-200/50`;
                // å¦‚æœå·²é€‰ä¸­ï¼Œè®¾ç½®é€‰ä¸­çŠ¶æ€çš„æ ·å¼
                if (isSelected) {
                    card.style.backgroundColor = '#f0f0f0';
                    card.style.borderColor = '#409EFF';
                    card.style.borderWidth = '1px';
                }
                // ç§»é™¤å¡ç‰‡çš„onclickäº‹ä»¶ï¼Œåªè®©å¤é€‰æ¡†å’Œæ ‡ç­¾å“åº”ç‚¹å‡»
                
                // è¿‡æ»¤æ ‡ç­¾ï¼šåªä¿ç•™æ ¸å¿ƒæ ‡ç­¾ï¼ˆè¿œç¨‹ã€å…¼èŒã€å…¨èŒç­‰ï¼‰ï¼Œæœ€å¤š3-4ä¸ª
                const allTags = Array.isArray(job.tags) ? job.tags : [];
                const coreTagKeywords = ['è¿œç¨‹', 'å…¼èŒ', 'å…¨èŒ', 'å®ä¹ ', 'Remote', 'Part-time', 'Full-time', 'Intern', 'Dev', 'Design', 'Marketing'];
                const coreTags = allTags.filter(tag => {
                    const tagLower = String(tag).toLowerCase();
                    return coreTagKeywords.some(keyword => tagLower.includes(keyword.toLowerCase()));
                }).slice(0, 4); // æœ€å¤šä¿ç•™4ä¸ª
                
                const tagsHtml = coreTags.map(tag => 
                    `<span class="px-2 py-1 rounded text-xs font-medium bg-slate-100 text-slate-600 mr-2">#${tag}</span>`
                ).join('');

                // æ„å»ºä¿¡æ¯è¡Œï¼ˆåªä¿ç•™é‚®ç®±ï¼‰
                const infoItems = [];
                if (job.email) {
                    infoItems.push(`<span class="flex items-center gap-1 text-blue-600 break-all text-xs">ğŸ“§ ${job.email}</span>`);
                }
                const infoRow = infoItems.length > 0 ? `<div class="flex flex-wrap gap-x-3 gap-y-1.5 text-xs text-slate-500 mb-2">${infoItems.join('')}</div>` : '';

                // æ„å»ºå²—ä½é“¾æ¥ï¼ˆåœ¨æ ‡ç­¾ä¸‹æ–¹æ˜¾ç¤ºï¼‰
                const jobLink = job.job_link || job.link || job.source_link || job.url || '';
                const jobLinkHtml = jobLink ? `<div class="mt-2 pointer-events-auto"><a href="${jobLink}" target="_blank" onclick="event.stopPropagation();" class="text-blue-600 hover:underline text-xs">ğŸ”— å²—ä½é“¾æ¥</a></div>` : '';

                // ä½¿ç”¨å²—ä½idç”Ÿæˆå”¯ä¸€çš„å¤é€‰æ¡†id
                const checkboxId = `checkbox-${job.id}`;
                const labelId = `label-${job.id}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="job-checkbox-wrapper flex-1 min-w-0">
                            <div class="flex-shrink-0 pt-0.5">
                                <input type="checkbox" id="${checkboxId}" name="selected-jobs" value="${job.id}" ${isSelected ? 'checked' : ''} 
                                       class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            </div>
                            <label for="${checkboxId}" id="${labelId}" class="flex-1 min-w-0 cursor-pointer">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <h3 class="font-bold text-slate-800 text-base group-hover:text-blue-600 transition-colors" title="${job.title || "æœªçŸ¥é¡¹ç›®"}">
                                        ${job.title || "æœªçŸ¥é¡¹ç›®"}
                                    </h3>
                                    ${job.company ? `<span class="text-red-600 text-sm font-medium">${job.company}</span>` : ''}
                                </div>
                            </label>
                        </div>
                        <div class="flex flex-col items-end gap-1.5 flex-shrink-0 ml-2 pointer-events-none">
                           <!-- æ—¥æœŸ -->
                           ${job.date ? `<div class="text-slate-500 text-xs">${job.date}</div>` : ''}
                           <!-- è–ªèµ„æ°”æ³¡ -->
                           ${job.salary ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800">${job.salary}</span>` : ''}
                        </div>
                    </div>
                    <div class="pl-6 pointer-events-none">
                        ${infoRow}
                        ${tagsHtml ? `<div class="flex flex-wrap gap-1.5 mb-2">${tagsHtml}</div>` : ''}
                        ${jobLinkHtml}
                    </div>
                `;
                
                // ä¸ºå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆç‹¬ç«‹å¤„ç†ï¼Œä¸è§¦å‘å…¨é€‰ï¼‰
                const checkbox = card.querySelector(`#${checkboxId}`);
                if (checkbox) {
                    checkbox.addEventListener('change', function(e) {
                        e.stopPropagation();
                        // ç¡®ä¿jobIdæ˜¯æ­£ç¡®ç±»å‹ï¼ˆå¯èƒ½æ˜¯æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰
                        const jobId = isNaN(this.value) ? this.value : (typeof job.id === 'number' ? parseInt(this.value) : this.value);
                        if (this.checked) {
                            selectedIds.add(jobId);
                        } else {
                            selectedIds.delete(jobId);
                        }
                        // åªæ›´æ–°å½“å‰å¡ç‰‡çš„æ ·å¼ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                        updateCardStyle(card, this.checked);
                        // å®æ—¶æ›´æ–°é€‰ä¸­è®¡æ•°
                        updateSelectedCount();
                        updateActionState();
                    });
                }
                
                // ä¸ºlabelæ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆç‚¹å‡»æ ‡ç­¾ä¹Ÿèƒ½é€‰ä¸­/å–æ¶ˆï¼‰
                const label = card.querySelector(`#${labelId}`);
                if (label) {
                    label.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const checkbox = document.getElementById(checkboxId);
                        if (checkbox) {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                }
                
                listEl.appendChild(card);
            });
            // æ¸²æŸ“å®Œæˆåï¼Œå®æ—¶æ›´æ–°é€‰ä¸­è®¡æ•°
            updateSelectedCount();
            updateActionState();
        }

        // æ›´æ–°å•ä¸ªå¡ç‰‡æ ·å¼ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨ï¼‰
        function updateCardStyle(card, isSelected) {
            if (isSelected) {
                // é€‰ä¸­çŠ¶æ€ï¼šæµ…ç°è‰²èƒŒæ™¯ + æ·¡è“è‰²è¾¹æ¡†
                card.style.backgroundColor = '#f0f0f0';
                card.style.borderColor = '#409EFF';
                card.style.borderWidth = '1px';
            } else {
                // æœªé€‰ä¸­çŠ¶æ€ï¼šæ¢å¤é»˜è®¤æ ·å¼
                card.style.backgroundColor = '';
                card.style.borderColor = '';
                card.style.borderWidth = '';
            }
        }

        // äº¤äº’é€»è¾‘ï¼šé€‰æ‹©èŒä½ï¼ˆä¿ç•™ç”¨äºå…¨é€‰åŠŸèƒ½ï¼‰
        function toggleSelect(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            renderJobs(); // å…¨é€‰æ—¶é‡æ–°æ¸²æŸ“
        }

        // äº¤äº’é€»è¾‘ï¼šå…¨é€‰/åé€‰
        function toggleSelectAll() {
            const btn = document.getElementById('selectAllBtn');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const catVal = document.getElementById('categorySelect').value;
            const typeVal = document.getElementById('typeSelect').value;
            
            // ä½¿ç”¨å’ŒrenderJobsç›¸åŒçš„ç­›é€‰é€»è¾‘
            const filteredJobs = currentJobs.filter(job => {
                const title = (job.title || "").toLowerCase();
                const company = (job.company || "").toLowerCase();
                const raw = (job.raw_content || "").toLowerCase();
                const tags = Array.isArray(job.tags) ? job.tags : [];
                const type = job.type || "";

                const matchSearch = !searchVal || title.includes(searchVal) || company.includes(searchVal) || raw.includes(searchVal);
                const matchCat = catVal === 'All' || tags.some(t => t.includes(catVal));
                const matchType = typeVal === 'All' || type.includes(typeVal);
                return matchSearch && matchCat && matchType;
            });
            
            const allIds = filteredJobs.map(j => j.id);
            const allSelected = allIds.every(id => selectedIds.has(id));
            
            if (allSelected) {
                // å–æ¶ˆå…¨é€‰
                allIds.forEach(id => {
                    selectedIds.delete(id);
                    const checkbox = document.getElementById(`checkbox-${id}`);
                    if (checkbox) {
                        checkbox.checked = false;
                        const card = checkbox.closest('.job-card');
                        if (card) updateCardStyle(card, false);
                    }
                });
                btn.innerText = "å…¨é€‰æœ¬é¡µ";
            } else {
                // å…¨é€‰
                allIds.forEach(id => {
                    selectedIds.add(id);
                    const checkbox = document.getElementById(`checkbox-${id}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        const card = checkbox.closest('.job-card');
                        if (card) updateCardStyle(card, true);
                    }
                });
                btn.innerText = "å–æ¶ˆå…¨é€‰";
            }
            // å®æ—¶æ›´æ–°é€‰ä¸­è®¡æ•°
            updateSelectedCount();
            updateActionState();
        }

        // äº¤äº’é€»è¾‘ï¼šæ–‡ä»¶ä¸Šä¼ 
        function setupEventListeners() {
            ['searchInput', 'categorySelect', 'typeSelect'].forEach(id => {
                document.getElementById(id).addEventListener('input', renderJobs);
            });

            const fileInput = document.getElementById('resumeInput');
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFile(file);
            });
        }

        function handleFile(file) {
            if (file && file.type === 'application/pdf') {
                resumeFile = file;
                document.getElementById('uploadPlaceholder').classList.add('hidden');
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('fileName').innerText = file.name;
                document.getElementById('dropZone').classList.add('border-green-400', 'bg-green-50');
            } else {
                alert('è¯·ä¸Šä¼  PDF æ ¼å¼çš„æ–‡ä»¶');
            }
            updateActionState();
        }

        // å®æ—¶ç»Ÿè®¡æ‰€æœ‰é€‰ä¸­å¤é€‰æ¡†çš„æ•°é‡
        function updateSelectedCount() {
            const countEl = document.getElementById('selectedCount');
            // æŸ¥è¯¢æ‰€æœ‰name="selected-jobs"ä¸”checked=trueçš„å¤é€‰æ¡†
            const checkedBoxes = document.querySelectorAll('input[name="selected-jobs"]:checked');
            const count = checkedBoxes.length;
            
            // æ›´æ–°æ˜¾ç¤ºçš„æ•°å­—
            countEl.innerText = count;
            
            return count;
        }

        // ä¸€é”®æ¸…é™¤æ‰€æœ‰é€‰ä¸­çš„å²—ä½
        function clearAllSelections() {
            // è·å–æ‰€æœ‰é€‰ä¸­çš„å¤é€‰æ¡†
            const checkedBoxes = document.querySelectorAll('input[name="selected-jobs"]:checked');
            
            // å–æ¶ˆæ‰€æœ‰å¤é€‰æ¡†çš„é€‰ä¸­çŠ¶æ€
            checkedBoxes.forEach(checkbox => {
                checkbox.checked = false;
                // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°å¡ç‰‡æ ·å¼
                checkbox.dispatchEvent(new Event('change'));
            });
            
            // æ¸…ç©ºselectedIdsé›†åˆ
            selectedIds.clear();
            
            // æ›´æ–°æ‰€æœ‰å¡ç‰‡çš„æ ·å¼ï¼ˆæ¢å¤æœªé€‰ä¸­çŠ¶æ€ï¼‰
            const allCards = document.querySelectorAll('.job-card');
            allCards.forEach(card => {
                updateCardStyle(card, false);
            });
            
            // æ›´æ–°è®¡æ•°å’ŒæŒ‰é’®çŠ¶æ€
            updateSelectedCount();
            updateActionState();
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateActionState() {
            const btn = document.getElementById('applyBtn');
            const clearBtn = document.getElementById('clearBtn');
            // ä½¿ç”¨å®æ—¶ç»Ÿè®¡å‡½æ•°è·å–å‡†ç¡®çš„é€‰ä¸­æ•°é‡
            const count = updateSelectedCount();

            // æ›´æ–°"ä¸€é”®æ¸…é™¤"æŒ‰é’®æ ·å¼
            if (count > 0) {
                // æœ‰é€‰ä¸­å²—ä½æ—¶ï¼šè“è‰²æ ·å¼ï¼ˆå’Œ"ä¸€é”®æŠ•é€’"ä¸€æ ·ï¼‰
                clearBtn.classList.remove('bg-slate-300', 'hover:bg-slate-400');
                clearBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'hover:-translate-y-0.5', 'shadow-blue-500/30');
            } else {
                // æœªé€‰ä¸­å²—ä½æ—¶ï¼šç°è‰²æ ·å¼
                clearBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'hover:-translate-y-0.5', 'shadow-blue-500/30');
                clearBtn.classList.add('bg-slate-300', 'hover:bg-slate-400');
            }

            // æ›´æ–°"ä¸€é”®æŠ•é€’"æŒ‰é’®çŠ¶æ€
            if (count > 0 && resumeFile) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-300', 'cursor-not-allowed');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'hover:-translate-y-0.5');
                btn.innerText = `ä¸€é”®æŠ•é€’ (${count})`;
            } else {
                btn.disabled = true;
                btn.classList.add('bg-slate-300', 'cursor-not-allowed');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'hover:-translate-y-0.5');
                btn.innerText = "ä¸€é”®æŠ•é€’";
            }
        }

        // æ¨¡æ‹Ÿ + çœŸå®æŠ•é€’è¿‡ç¨‹
        async function startApplying() {
            if (!resumeFile || selectedIds.size === 0) return;

            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('sending-view').classList.remove('hidden');
            
            const logContainer = document.getElementById('logContainer');
            const progressBar = document.getElementById('progressBar');
            const progressTitle = document.getElementById('progressTitle');
            
            logContainer.innerHTML = '';
            
            // å‘åç«¯å‘é€è¯·æ±‚
            const jobIds = Array.from(selectedIds);
            fetch(`${API_BASE_URL}/send-resume`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jobIds: jobIds }) 
            }).catch(err => console.error("åç«¯æŠ•é€’æ¥å£æŠ¥é”™ (ä»…æ¼”ç¤º):", err));

            const jobsToApply = currentJobs.filter(j => selectedIds.has(j.id));
            let completed = 0;

            for (const job of jobsToApply) {
                await new Promise(r => setTimeout(r, 600));
                
                const success = true; 
                const time = new Date().toLocaleTimeString();
                
                const logItem = document.createElement('div');
                logItem.className = "fade-in p-4 border-b border-slate-50 flex items-center justify-between hover:bg-slate-50";
                logItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-green-500 font-bold">âœ” Sent</span>
                        <div class="min-w-0">
                            <div class="font-medium text-slate-800 text-sm truncate w-40 sm:w-64" title="${job.email}">${job.email}</div>
                        </div>
                    </div>
                `;
                logContainer.prepend(logItem);

                completed++;
                const percent = Math.round((completed / jobsToApply.length) * 100);
                progressBar.style.width = `${percent}%`;
                progressTitle.innerText = `Sending... ${percent}%`;
            }
            
            progressTitle.innerText = "Finished";
        }

        function resetView() {
            document.getElementById('sending-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
        }

    </script>
</body>
</html>